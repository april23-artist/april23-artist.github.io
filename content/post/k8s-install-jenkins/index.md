---
title: Kubernetes Cluster 安裝 Jenkins
slug: k8s-install-jenkins
date: "2024-12-30"
categories:
  - "Kubernetes"
  - "DevOps"
tags:
  - "Jenkins"
  - "Ngrok"
  - "NFS"
  - "Helm"
  - "Provisioner"
weight: 1
---

## 前言

將 Jenkins 運行在 Kubernetes 上，可以大大提升 Jenkins 的彈性、擴展性和自動化管理。
Jenkins 可以與 Kubernetes 上的其他服務 (如 Docker、Helm 等) 進行集成，實現更靈活和自動化的 Pipeline 流程

## 步驟

### 透過 Helm 下載 Jenkins

```bash
helm repo add jenkinsci https://charts.jenkins.io
helm repo update
# 查看 Jenkins repo
helm search repo jenkinsci
```

### 新增 Provisioner 讓建立 Jenkins 時透過 StorageClass 自動產生存取 PVC、PV

假設 NFS 服務共享目錄為 /home/nfs/rw/jenkins 。

```bash
# 加上共享設定
# /home/nfs/rw/jenkins <nfs_server_ip>.0.0/16(rw,sync,no_subtree_check,no_root_squash)
sudo nano /etc/exports
```

```bash
# <nfs_path>: 共享的目錄 /home/nfs/rw/jenkins
sudo helm install <provisioner_name> nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
    --version 4.0.18 \
    --namespace nfs \
    --set nfs.server=<nfs_server_ip> \
    --set nfs.path=<nfs_path> \
    --set storageClass.name=<storageClass_name> \
    --kubeconfig /etc/rancher/k3s/k3s.yaml
```

### 新增 Service Account

在目錄中新增 [jenkins-sa.yaml](https://raw.githubusercontent.com/installing-jenkins-on-kubernetes/jenkins-sa.yaml) 並且建立起來。

```bash
sudo kubectl apply -f jenkins-sa.yaml
```

### 新增 Values

在目錄中新增 [jenkins-values.yaml](raw.githubusercontent.com/jenkinsci/helm-charts/main/charts/jenkins/values.yaml) 並且調整設定。

```yaml
# 指定剛才建立的 Provisioner 所提供的 <storageClass_name>
storageClass: <storageClass_name>

serviceAccount:
  create: false
# Service account name is autogenerated by default
name: jenkins
annotations: {}
```

### 使用 Helm 安裝

```bash
# 安裝 Jenkins
sudo helm install jenkins -n jenkins -f jenkins-values.yaml jenkinsci/jenkins --kubeconfig /etc/rancher/k3s/k3s.yaml
# 卸載 Jenkins
sudo helm uninstall jenkins -n jenkins --kubeconfig /etc/rancher/k3s/k3s.yaml
#取得 admin 用戶的密碼
jsonpath="{.data.jenkins-admin-password}"
secret=$(sudo kubectl get secret -n jenkins jenkins -o jsonpath=$jsonpath --kubeconfig /etc/rancher/k3s/k3s.yaml)
echo $(echo $secret | base64 --decode)
```

## 參考

- [Jenkins](https://www.jenkins.io/)
- [Install Jenkins with Helm v3](https://www.jenkins.io/doc/book/installing/kubernetes/#install-jenkins-with-helm-v3)
- [Ngrok](https://ngrok.com/)
